#!/bin/bash

indent() {
  sed -u 's/^/       /'
}

BUILD_DIR=$1
CACHE_DIR=$2

PERL_VERSION="5.26.1"
CONFIG_VERSION="b"

VENDORED_PERL="/app/vendor/perl"
CACHED_PERL="$CACHE_DIR/perl-$PERL_VERSION-$CONFIG_VERSION.tar.bz2"
if [ -f $CACHED_PERL ] && cd $BUILD_DIR; then
  echo Restoring cached perl
  tar xjf $CACHED_PERL
  echo All done.
  exit
fi

echo "-----> Vendoring Perl"

mkdir -p $VENDORED_PERL || { echo "Can't create build dir"; exit 1; }
cd $VENDORED_PERL
export PERLBREW_ROOT=$VENDORED_PERL
curl -L https://install.perlbrew.pl | bash
echo Perlbrew init
source $VENDORED_PERL/etc/bashrc
perlbrew init
echo Perlbrew cpanm
perlbrew install-cpanm
echo Perlbrew install
perlbrew install perl-$PERL_VERSION
echo Switching to new perl.
perlbrew switch perl-$PERL_VERSION
echo "Using Perl $PERL_VERSION" | indent
if [ -f $BUILD_DIR/Makefile.PL ] || [ -f $BUILD_DIR/cpanfile ]; then
  echo "-----> Installing dependencies"
  cpanm local::lib
  cpanm --notest --installdeps $BUILD_DIR
  echo "Dependencies installed" | indent
fi
echo Removing build files
rm -r vendor/perl/{build,dists}
echo Caching perl
cd /app && tar cjf $CACHED_PERL .perlbrew vendor/perl
echo Restoring cache
cd $BUILD_DIR && tar xjf $CACHED_PERL
echo All done.
